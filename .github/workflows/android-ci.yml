name: Android CI - ç¼–è¯‘ / æµ‹è¯• / æ‰“åŒ…

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'android/**'
      - '.github/workflows/android-ci.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'android/**'
      - '.github/workflows/android-ci.yml'
  workflow_dispatch:

# åŒä¸€åˆ†æ”¯/PR æ–°æ¨é€æ—¶å–æ¶ˆæ—§çš„è¿è¡Œ
concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  GRADLE_VERSION: '8.5'

jobs:
  # ============================================================
  # Job 1: Lint æ£€æŸ¥
  # ============================================================
  lint:
    name: Lint æ£€æŸ¥
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date -u '+%Y%m%d-%H%M')" >> $GITHUB_ENV

      - name: é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: é…ç½® Gradle (ç›´æ¥å®‰è£…ï¼Œä¸ä¾èµ– wrapper jar)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: è¿è¡Œ Lint æ£€æŸ¥
        run: gradle lintDebug --stacktrace

      - name: ä¸Šä¼  Lint æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: familytree-lint-report-${{ env.TIMESTAMP }}
          path: android/app/build/reports/lint-results-debug.html
          retention-days: 14
          if-no-files-found: warn

  # ============================================================
  # Job 2: å•å…ƒæµ‹è¯•
  # ============================================================
  unit-test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date -u '+%Y%m%d-%H%M')" >> $GITHUB_ENV

      - name: é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: é…ç½® Gradle (ç›´æ¥å®‰è£…ï¼Œä¸ä¾èµ– wrapper jar)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: gradle testDebugUnitTest --stacktrace

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ (JUnit XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: familytree-unit-test-results-${{ env.TIMESTAMP }}
          path: android/app/build/test-results/testDebugUnitTest/
          retention-days: 14
          if-no-files-found: warn

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: familytree-unit-test-report-${{ env.TIMESTAMP }}
          path: android/app/build/reports/tests/testDebugUnitTest/
          retention-days: 14
          if-no-files-found: warn

      - name: å‘å¸ƒæµ‹è¯•æŠ¥å‘Šåˆ° Checks
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: å•å…ƒæµ‹è¯•æŠ¥å‘Š
          path: android/app/build/test-results/testDebugUnitTest/*.xml
          reporter: java-junit
          fail-on-error: false
          fail-on-empty: false

  # ============================================================
  # Job 3: Roborazzi æˆªå›¾æµ‹è¯•
  # ============================================================
  screenshot-test:
    name: æˆªå›¾æµ‹è¯• (Roborazzi)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: android

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date -u '+%Y%m%d-%H%M')" >> $GITHUB_ENV

      - name: é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: é…ç½® Gradle (ç›´æ¥å®‰è£…ï¼Œä¸ä¾èµ– wrapper jar)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: å½•åˆ¶æˆªå›¾
        run: gradle recordRoborazziDebug --stacktrace

      - name: ç”Ÿæˆæˆªå›¾ HTML æŠ¥å‘Š
        if: always()
        run: |
          SCREENSHOT_DIR="app/screenshots"
          REPORT_FILE="app/build/screenshot-report.html"
          mkdir -p "$(dirname $REPORT_FILE)"

          SCREENSHOTS=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | sort)
          COUNT=$(echo "$SCREENSHOTS" | grep -c ".png" || echo "0")

          cat > "$REPORT_FILE" << 'HTMLHEADER'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>FamilyTree æˆªå›¾æµ‹è¯•æŠ¥å‘Š</title>
          <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
          h1 { text-align: center; margin-bottom: 8px; color: #2E7D32; }
          .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
          .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; max-width: 1400px; margin: 0 auto; }
          .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
          .card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
          .card img { width: 100%; height: auto; display: block; border-bottom: 1px solid #eee; }
          .card-title { padding: 12px 16px; font-weight: 600; font-size: 14px; color: #444; }
          .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; }
          .badge-light { background: #E8F5E9; color: #2E7D32; }
          .badge-dark { background: #333; color: #fff; }
          .header-info { text-align: center; margin-bottom: 20px; color: #888; font-size: 13px; }
          </style>
          </head>
          <body>
          <h1>ğŸŒ³ FamilyTree æˆªå›¾æµ‹è¯•æŠ¥å‘Š</h1>
          <p class="subtitle">Roborazzi è‡ªåŠ¨æˆªå›¾ Â· Compose UI</p>
          HTMLHEADER

          sed -i 's/^          //' "$REPORT_FILE"

          TIMESTAMP_DISPLAY=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "<p class=\"header-info\">ç”Ÿæˆæ—¶é—´: ${TIMESTAMP_DISPLAY} | æˆªå›¾æ•°é‡: ${COUNT}</p>" >> "$REPORT_FILE"
          echo '<div class="grid">' >> "$REPORT_FILE"

          if [ -n "$SCREENSHOTS" ] && [ "$COUNT" -gt 0 ]; then
            for img in $SCREENSHOTS; do
              FILENAME=$(basename "$img" .png)
              B64=$(base64 -w0 "$img")

              if echo "$FILENAME" | grep -q "_dark"; then
                BADGE='<span class="badge badge-dark">æ·±è‰²</span>'
                DISPLAY_NAME=$(echo "$FILENAME" | sed 's/_dark$//')
              else
                BADGE='<span class="badge badge-light">æµ…è‰²</span>'
                DISPLAY_NAME="$FILENAME"
              fi

              cat >> "$REPORT_FILE" << EOF
          <div class="card">
            <img src="data:image/png;base64,${B64}" alt="${FILENAME}" loading="lazy">
            <div class="card-title">${DISPLAY_NAME} ${BADGE}</div>
          </div>
          EOF
            done
          else
            echo '<p style="text-align:center;color:#999;grid-column:1/-1;padding:40px;">æœªæ‰¾åˆ°æˆªå›¾æ–‡ä»¶</p>' >> "$REPORT_FILE"
          fi

          echo '</div></body></html>' >> "$REPORT_FILE"
          sed -i 's/^          //' "$REPORT_FILE"

          echo "screenshot_count=${COUNT}" >> $GITHUB_ENV
          echo "âœ… ç”Ÿæˆæˆªå›¾æŠ¥å‘Š: ${COUNT} å¼ æˆªå›¾"

      - name: ç”Ÿæˆ Job Summary æˆªå›¾é¢„è§ˆ
        if: always()
        run: |
          SCREENSHOT_DIR="app/screenshots"
          SCREENSHOTS=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | sort)
          COUNT=$(echo "$SCREENSHOTS" | grep -c ".png" || echo "0")

          {
            echo "## ğŸ“¸ Roborazzi æˆªå›¾æµ‹è¯•"
            echo ""
            echo "å…±æ•è· **${COUNT}** å¼ å±å¹•æˆªå›¾"
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          if [ -n "$SCREENSHOTS" ] && [ "$COUNT" -gt 0 ]; then
            echo "| å±å¹• | ä¸»é¢˜ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            for img in $SCREENSHOTS; do
              FILENAME=$(basename "$img" .png)
              if echo "$FILENAME" | grep -q "_dark"; then
                DISPLAY_NAME=$(echo "$FILENAME" | sed 's/_dark$//')
                echo "| ${DISPLAY_NAME} | ğŸŒ™ æ·±è‰² |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| ${FILENAME} | â˜€ï¸ æµ…è‰² |" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ğŸ’¡ ä¸‹è½½ **familytree-screenshot-report** æ„ä»¶å¹¶æ‰“å¼€ HTML æ–‡ä»¶å³å¯é¢„è§ˆæ‰€æœ‰æˆªå›¾" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ æˆªå›¾ (åŸå§‹ PNG)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: familytree-screenshots-${{ env.TIMESTAMP }}
          path: android/app/screenshots/
          retention-days: 14
          if-no-files-found: warn

      - name: ä¸Šä¼ æˆªå›¾ HTML æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: familytree-screenshot-report-${{ env.TIMESTAMP }}
          path: android/app/build/screenshot-report.html
          retention-days: 14
          if-no-files-found: warn

  # ============================================================
  # Job 4: ç¼–è¯‘ & æ‰“åŒ… Debug APK
  # ============================================================
  build-debug:
    name: ç¼–è¯‘ Debug APK
    runs-on: ubuntu-latest
    needs: [ lint, unit-test, screenshot-test ]
    defaults:
      run:
        working-directory: android

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date -u '+%Y%m%d-%H%M')" >> $GITHUB_ENV

      - name: é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: é…ç½® Gradle (ç›´æ¥å®‰è£…ï¼Œä¸ä¾èµ– wrapper jar)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: ç¼–è¯‘ Debug APK
        run: gradle assembleDebug --stacktrace

      - name: é‡å‘½å APK (é™„åŠ ç‰ˆæœ¬å’Œæ„å»ºå·)
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          BUILD_NUMBER=${{ github.run_number }}
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          APK_NAME="FamilyTree-debug-v${VERSION_NAME}-build${BUILD_NUMBER}-${SHORT_SHA}.apk"
          cp app/build/outputs/apk/debug/app-debug.apk "app/build/outputs/apk/debug/${APK_NAME}"
          echo "APK_NAME=${APK_NAME}" >> $GITHUB_ENV
          echo "APK_PATH=app/build/outputs/apk/debug/${APK_NAME}" >> $GITHUB_ENV

      - name: ä¸Šä¼  Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: familytree-debug-apk-${{ env.TIMESTAMP }}
          path: android/app/build/outputs/apk/debug/FamilyTree-*.apk
          retention-days: 30

  # ============================================================
  # Job 5: ç¼–è¯‘ & æ‰“åŒ… Release APK
  # ============================================================
  build-release:
    name: ç¼–è¯‘ Release APK
    runs-on: ubuntu-latest
    needs: [ lint, unit-test, screenshot-test ]
    defaults:
      run:
        working-directory: android

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date -u '+%Y%m%d-%H%M')" >> $GITHUB_ENV

      - name: é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: é…ç½® Gradle (ç›´æ¥å®‰è£…ï¼Œä¸ä¾èµ– wrapper jar)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}

      - name: ç¼–è¯‘ Release APK (æœªç­¾å)
        run: gradle assembleRelease --stacktrace

      - name: é‡å‘½å Release APK
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          BUILD_NUMBER=${{ github.run_number }}
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          APK_NAME="FamilyTree-release-v${VERSION_NAME}-build${BUILD_NUMBER}-${SHORT_SHA}.apk"
          cp app/build/outputs/apk/release/app-release-unsigned.apk "app/build/outputs/apk/release/${APK_NAME}"
          echo "APK_NAME=${APK_NAME}" >> $GITHUB_ENV

      - name: ä¸Šä¼  Release APK
        uses: actions/upload-artifact@v4
        with:
          name: familytree-release-apk-${{ env.TIMESTAMP }}
          path: android/app/build/outputs/apk/release/FamilyTree-*.apk
          retention-days: 30

  # ============================================================
  # Job 6: åœ¨ PR ä¸­å‘å¸ƒæ„å»ºæ‘˜è¦è¯„è®º
  # ============================================================
  comment-on-pr:
    name: å‘å¸ƒ PR æ„å»ºæ‘˜è¦
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request' && !cancelled()
    needs: [ lint, unit-test, screenshot-test, build-debug, build-release ]
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰ Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: æ”¶é›†æµ‹è¯•ç»“æœ
        id: test-results
        if: always()
        run: |
          echo "## ğŸ“Š å•å…ƒæµ‹è¯•ç»“æœ" >> test_summary.md
          echo "" >> test_summary.md

          TOTAL=0
          PASSED=0
          FAILED=0
          ERRORS=0
          SKIPPED=0

          # ä½¿ç”¨ find æŸ¥æ‰¾æµ‹è¯•ç»“æœ XMLï¼ˆé€‚é…å¸¦æ—¶é—´æˆ³çš„ç›®å½•åï¼‰
          XML_FILES=$(find artifacts -path "*/familytree-unit-test-results-*/*.xml" 2>/dev/null)

          if [ -n "$XML_FILES" ]; then
            for xml_file in $XML_FILES; do
              if [ -f "$xml_file" ]; then
                FILE_TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml_file" | head -1 || echo "0")
                FILE_FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml_file" | head -1 || echo "0")
                FILE_ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml_file" | head -1 || echo "0")
                FILE_SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$xml_file" | head -1 || echo "0")

                TOTAL=$((TOTAL + FILE_TESTS))
                FAILED=$((FAILED + FILE_FAILURES))
                ERRORS=$((ERRORS + FILE_ERRORS))
                SKIPPED=$((SKIPPED + FILE_SKIPPED))
              fi
            done
            PASSED=$((TOTAL - FAILED - ERRORS - SKIPPED))

            if [ "$FAILED" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
              echo "| çŠ¶æ€ | âœ… å…¨éƒ¨é€šè¿‡ |" >> test_summary.md
            else
              echo "| çŠ¶æ€ | âŒ å­˜åœ¨å¤±è´¥ |" >> test_summary.md
            fi
            echo "|------|------|" >> test_summary.md
            echo "| æ€»è®¡ | $TOTAL |" >> test_summary.md
            echo "| âœ… é€šè¿‡ | $PASSED |" >> test_summary.md
            echo "| âŒ å¤±è´¥ | $FAILED |" >> test_summary.md
            echo "| âš ï¸ é”™è¯¯ | $ERRORS |" >> test_summary.md
            echo "| â­ï¸ è·³è¿‡ | $SKIPPED |" >> test_summary.md
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å•å…ƒæµ‹è¯•ç»“æœ" >> test_summary.md
          fi

          echo "" >> test_summary.md
          cat test_summary.md

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: æ„å»º PR è¯„è®ºå†…å®¹
        id: build-comment
        if: always()
        env:
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SHORT_SHA=$(echo "$SHA" | cut -c1-7)
          WORKFLOW_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          ARTIFACTS_URL="${WORKFLOW_URL}#artifacts"

          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.unit-test.result }}"
          SCREENSHOT_STATUS="${{ needs.screenshot-test.result }}"
          DEBUG_STATUS="${{ needs.build-debug.result }}"
          RELEASE_STATUS="${{ needs.build-release.result }}"

          status_icon() {
            case "$1" in
              success)  echo "âœ…" ;;
              failure)  echo "âŒ" ;;
              skipped)  echo "â­ï¸" ;;
              cancelled) echo "ğŸš«" ;;
              *)        echo "âš ï¸" ;;
            esac
          }

          {
            echo "## ğŸ¤– Android CI æ„å»ºæŠ¥å‘Š"
            echo ""
            echo "**æäº¤:** \`${SHORT_SHA}\` | **æ„å»º:** [#${RUN_ID}](${WORKFLOW_URL})"
            echo ""
            echo "---"
            echo ""
            echo "### ğŸ“‹ æ„å»ºæµæ°´çº¿çŠ¶æ€"
            echo ""
            echo "| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |"
            echo "|------|------|------|"
            echo "| ğŸ” Lint æ£€æŸ¥ | $(status_icon $LINT_STATUS) ${LINT_STATUS} | ä»£ç è§„èŒƒä¸æ½œåœ¨é—®é¢˜æ£€æŸ¥ |"
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | $(status_icon $TEST_STATUS) ${TEST_STATUS} | JUnit æœ¬åœ°å•å…ƒæµ‹è¯• |"
            echo "| ğŸ“¸ æˆªå›¾æµ‹è¯• | $(status_icon $SCREENSHOT_STATUS) ${SCREENSHOT_STATUS} | Roborazzi UI æˆªå›¾æµ‹è¯• |"
            echo "| ğŸ”¨ Debug æ„å»º | $(status_icon $DEBUG_STATUS) ${DEBUG_STATUS} | Debug APK ç¼–è¯‘æ‰“åŒ… |"
            echo "| ğŸ“¦ Release æ„å»º | $(status_icon $RELEASE_STATUS) ${RELEASE_STATUS} | Release APK ç¼–è¯‘æ‰“åŒ… |"
          } > pr_comment.md

          if [ -f test_summary.md ]; then
            echo "" >> pr_comment.md
            echo "---" >> pr_comment.md
            echo "" >> pr_comment.md
            cat test_summary.md >> pr_comment.md
          fi

          {
            echo ""
            echo "---"
            echo ""
            echo "### ğŸ“¥ æ„ä»¶ä¸‹è½½"
            echo ""
            echo "> æ‰€æœ‰æ„ä»¶åç§°åŒ…å«ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆå¦‚ \`familytree-debug-apk-20260226-0305\`ï¼‰ï¼Œå¤šæ¬¡ä¸‹è½½ä¸ä¼šè¦†ç›–ã€‚"
            echo "> å‰å¾€ [Actions Artifacts](${ARTIFACTS_URL}) é¡µé¢ä¸‹è½½ï¼ˆéœ€ç™»å½• GitHubï¼‰ã€‚"
            echo ""
            echo "| æ„ä»¶ | è¯´æ˜ | ä¿ç•™å¤©æ•° |"
            echo "|------|------|----------|"
            echo "| ğŸ“± **familytree-debug-apk-\`æ—¶é—´æˆ³\`** | Debug ç‰ˆæœ¬ APKï¼ˆå¯ç›´æ¥å®‰è£…æµ‹è¯•ï¼‰ | 30 å¤© |"
            echo "| ğŸ“¦ **familytree-release-apk-\`æ—¶é—´æˆ³\`** | Release ç‰ˆæœ¬ APKï¼ˆæœªç­¾åï¼‰ | 30 å¤© |"
            echo "| ğŸ“¸ **familytree-screenshot-report-\`æ—¶é—´æˆ³\`** | æˆªå›¾æµ‹è¯• HTML æŠ¥å‘Šï¼ˆæ‰“å¼€å³å¯é¢„è§ˆæ‰€æœ‰æˆªå›¾ï¼‰ | 14 å¤© |"
            echo "| ğŸ“¸ **familytree-screenshots-\`æ—¶é—´æˆ³\`** | æˆªå›¾åŸå§‹ PNG æ–‡ä»¶ | 14 å¤© |"
            echo "| ğŸ“Š **familytree-unit-test-report-\`æ—¶é—´æˆ³\`** | å•å…ƒæµ‹è¯• HTML æŠ¥å‘Š | 14 å¤© |"
            echo "| ğŸ“Š **familytree-unit-test-results-\`æ—¶é—´æˆ³\`** | å•å…ƒæµ‹è¯• JUnit XML åŸå§‹ç»“æœ | 14 å¤© |"
            echo "| ğŸ” **familytree-lint-report-\`æ—¶é—´æˆ³\`** | Lint æ£€æŸ¥ HTML æŠ¥å‘Š | 14 å¤© |"
            echo ""
            echo "---"
            echo ""
            echo "<details>"
            echo "<summary>ğŸ’¡ å¦‚ä½•ä½¿ç”¨ Debug APK</summary>"
            echo ""
            echo "1. è¿›å…¥ [Artifacts ä¸‹è½½é¡µé¢](${ARTIFACTS_URL})"
            echo "2. ä¸‹è½½ **familytree-debug-apk-\`æ—¶é—´æˆ³\`** å‹ç¼©åŒ…"
            echo "3. è§£å‹è·å¾— \`.apk\` æ–‡ä»¶"
            echo "4. ä¼ è¾“åˆ° Android è®¾å¤‡å¹¶å®‰è£…ï¼ˆéœ€å¼€å¯\"å…è®¸å®‰è£…æœªçŸ¥æ¥æº\"ï¼‰"
            echo "5. æˆ–ä½¿ç”¨ \`adb install <apkæ–‡ä»¶è·¯å¾„>\` å‘½ä»¤å®‰è£…"
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo "<sub>ğŸ¤– æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | $(date -u '+%Y-%m-%d %H:%M:%S UTC')</sub>"
          } >> pr_comment.md

          cat pr_comment.md

      - name: æŸ¥æ‰¾å·²æœ‰è¯„è®º
        if: always()
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'ğŸ¤– Android CI æ„å»ºæŠ¥å‘Š'

      - name: åˆ›å»ºæˆ–æ›´æ–° PR è¯„è®º
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: pr_comment.md
          edit-mode: replace

  # ============================================================
  # Job 7: ç”Ÿæˆ GitHub Actions Job Summary
  # ============================================================
  build-summary:
    name: ç”Ÿæˆæ„å»ºæ‘˜è¦
    runs-on: ubuntu-latest
    if: always()
    needs: [ lint, unit-test, screenshot-test, build-debug, build-release ]

    steps:
      - name: ä¸‹è½½æµ‹è¯•ç»“æœ
        if: always()
        uses: actions/download-artifact@v4
        with:
          pattern: familytree-unit-test-results-*
          path: test-results
          merge-multiple: true
        continue-on-error: true

      - name: ç”Ÿæˆ Job Summary
        if: always()
        env:
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          SHORT_SHA=$(echo "$SHA" | cut -c1-7)
          WORKFLOW_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          ARTIFACTS_URL="${WORKFLOW_URL}#artifacts"

          LINT_STATUS="${{ needs.lint.result }}"
          TEST_STATUS="${{ needs.unit-test.result }}"
          SCREENSHOT_STATUS="${{ needs.screenshot-test.result }}"
          DEBUG_STATUS="${{ needs.build-debug.result }}"
          RELEASE_STATUS="${{ needs.build-release.result }}"

          status_icon() {
            case "$1" in
              success)  echo "âœ…" ;;
              failure)  echo "âŒ" ;;
              skipped)  echo "â­ï¸" ;;
              cancelled) echo "ğŸš«" ;;
              *)        echo "âš ï¸" ;;
            esac
          }

          {
            echo "## ğŸ¤– Android CI æ„å»ºæ‘˜è¦"
            echo ""
            echo "**æäº¤:** \`${SHORT_SHA}\` | **æ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### ğŸ“‹ æµæ°´çº¿çŠ¶æ€"
            echo ""
            echo "| é˜¶æ®µ | çŠ¶æ€ |"
            echo "|------|------|"
            echo "| ğŸ” Lint æ£€æŸ¥ | $(status_icon $LINT_STATUS) ${LINT_STATUS} |"
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | $(status_icon $TEST_STATUS) ${TEST_STATUS} |"
            echo "| ğŸ“¸ æˆªå›¾æµ‹è¯• | $(status_icon $SCREENSHOT_STATUS) ${SCREENSHOT_STATUS} |"
            echo "| ğŸ”¨ Debug æ„å»º | $(status_icon $DEBUG_STATUS) ${DEBUG_STATUS} |"
            echo "| ğŸ“¦ Release æ„å»º | $(status_icon $RELEASE_STATUS) ${RELEASE_STATUS} |"
          } >> $GITHUB_STEP_SUMMARY

          TOTAL=0
          PASSED=0
          FAILED=0

          if [ -d "test-results" ]; then
            for xml_file in $(find test-results -name "*.xml" 2>/dev/null); do
              if [ -f "$xml_file" ]; then
                FILE_TESTS=$(grep -oP 'tests="\K[0-9]+' "$xml_file" | head -1 || echo "0")
                FILE_FAILURES=$(grep -oP 'failures="\K[0-9]+' "$xml_file" | head -1 || echo "0")
                FILE_ERRORS=$(grep -oP 'errors="\K[0-9]+' "$xml_file" | head -1 || echo "0")
                TOTAL=$((TOTAL + FILE_TESTS))
                FAILED=$((FAILED + FILE_FAILURES + FILE_ERRORS))
              fi
            done
            PASSED=$((TOTAL - FAILED))

            {
              echo ""
              echo "### ğŸ“Š æµ‹è¯•ç»“æœ"
              echo ""
              echo "| æŒ‡æ ‡ | æ•°å€¼ |"
              echo "|------|------|"
              echo "| æ€»è®¡ | $TOTAL |"
              echo "| âœ… é€šè¿‡ | $PASSED |"
              echo "| âŒ å¤±è´¥ | $FAILED |"
            } >> $GITHUB_STEP_SUMMARY
          fi

          {
            echo ""
            echo "### ğŸ“¥ æ„ä»¶ä¸‹è½½"
            echo ""
            echo "> æ‰€æœ‰æ„ä»¶åç§°åŒ…å«æ—¶é—´æˆ³ï¼Œå¤šæ¬¡ä¸‹è½½ä¸ä¼šè¦†ç›–ã€‚"
            echo ""
            echo "å‰å¾€ [Artifacts](${ARTIFACTS_URL}) ä¸‹è½½ï¼š"
            echo "- ğŸ“± **familytree-debug-apk** â€” Debug APK"
            echo "- ğŸ“¦ **familytree-release-apk** â€” Release APK (æœªç­¾å)"
            echo "- ğŸ“¸ **familytree-screenshot-report** â€” æˆªå›¾æµ‹è¯• HTML æŠ¥å‘Š"
            echo "- ğŸ“¸ **familytree-screenshots** â€” æˆªå›¾åŸå§‹ PNG æ–‡ä»¶"
            echo "- ğŸ“Š **familytree-unit-test-report** â€” æµ‹è¯•æŠ¥å‘Š"
            echo "- ğŸ” **familytree-lint-report** â€” Lint æŠ¥å‘Š"
          } >> $GITHUB_STEP_SUMMARY
